<!DOCTYPE html>
<html>
<head>
    <title>Pharmacy Bill</title>
    <style>
        body {
            background-color: #EEE;
            font-family: Arial, sans-serif;
        }
        .search-form-container {
            margin: 20px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            width: 90%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-form, .sno-form, .controls-form {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .controls-form {
             margin-top: 15px;
             padding-top: 15px;
             border-top: 1px solid #dee2e6;
        }
        .sno-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .search-form label, .sno-form label, .controls-form label {
            font-weight: bold;
        }
        .search-form input[type="text"], .search-form select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-form button, .sno-form button, #print_button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        #print_button {
            background-color: #28a745; /* Green for print */
        }
        .search-form button:hover, .sno-form button:hover {
            background-color: #0056b3;
        }
        #print_button:hover {
            background-color: #218838;
        }
        .sno-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
        }
        .sno-checkbox-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }
        /* Switch styles */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 24px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 24px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 16px;
          width: 16px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: #2196F3;
        }
        input:checked + .slider:before {
          transform: translateX(26px);
        }
        .page {
            background: white;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            margin-bottom: 0.5cm;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
            width: 90%; /* Match search form width for screen */
        }
        .page[size="A4"] {  
            /* A4 size is enforced for printing only */
            padding: 1.5cm;
        }
        .page-content {
            flex-grow: 1;
        }
        .header-table, .bill-info-table, .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
        }
        .header-table td {
            padding: 2px;
            vertical-align: top;
        }
        .header-table .shop-details {
            text-align: center;
        }
        .header-table h2 {
            margin: 0;
            font-size: 20px;
            font-weight: bold;
        }
        .bill-info-table td {
            border: 1px solid #333;
            padding: 5px;
        }
        .bill-info-table .label {
            font-weight: bold;
            width: 15%;
        }
        .bill-info-table .value {
            width: 35%;
        }
        .items-table th, .items-table td {
            border: 1px solid #333;
            padding: 5px;
            text-align: left;
        }
        .items-table th {
            background-color: #f2f2f2;
        }
        .items-table .right {
            text-align: right;
        }
        .items-table tfoot td {
            font-weight: bold;
            font-size: 14px;
        }

        @media print {
            body, .page {
                margin: 0;
                box-shadow: none;
                background: white;
                width: auto; /* Reset width for print */
            }
            .page[size="A4"] {
                width: 21cm;
                height: 29.7cm;
            }
            .search-form-container {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="search-form-container">
        <form method="POST" id="main_form">
            <div class="search-form">
                <label for="bill_no">Bill No:</label>
                <input type="text" id="bill_no" name="bill_no" required value="{{ request.form.bill_no }}">
                <label for="year">Year:</label>
                <select id="year" name="year" required>
                    {% for year in years %}
                    <option value="{{ year }}" {% if request.form.year == year|string %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
                 <label>Show Seq ID:</label>
                <label class="switch">
                  <input type="checkbox" name="show_seq_id" {% if show_seq_id %}checked{% endif %}>
                  <span class="slider"></span>
                </label>
                <label>Show SNo:</label>
                <label class="switch">
                  <input type="checkbox" name="show_sno" {% if show_sno %}checked{% endif %}>
                  <span class="slider"></span>
                </label>

                <button type="submit" name="search_bill">Search</button>
            </div>
 
            {% if rows %}
            <div class="sno-form">
                <label for="sno_checkbox">Select SNo:</label>
                <div class="sno-checkbox-container">
                    {% for row in rows %}
                    <label>
                        <input type="checkbox" name="sno_checkbox" value="{{ row.SNo }}" checked>
                        {{ row.SNo }}
                    </label>
                    {% endfor %}
                </div>
                <button type="submit" name="search_sno">Filter with SNo</button>
                           {% if header_data %}
                <button type="button" id="print_button">Print Bill</button>
                {% endif %}
            </div>
            {% endif %}
        </form>
    </div>

    {% if header_data %}
    <div class="page" size="A4">
        <div class="page-content">
            <table class="header-table">
                <tr>
                    <td style="width:33%;">DL No: TNY/3006/20,21</td>
                    <td style="width:34%;" class="shop-details">
                        <h2>Lakshmi Hospital Pharmacy</h2>
                        <p>101 A, Madurai Road, Tirunelveli</p>
                        <p>Ph: 0462 2334812</p>
                    </td>
                    <td style="width:33%; text-align:right;">GSTIN: 33AALPL3839M1ZA</td>
                </tr>
                 <tr>
                    <td colspan="3" style="text-align:center; padding-top:5px;">Bill Printed As On: {{ print_time }}</td>
                </tr>
            </table>

            <table class="bill-info-table">
                <tr>
                    <td class="label">Bill No:</td>
                    <td class="value">{{ header_data.BillNo }}</td>
                    <td class="label">Bill Date:</td>
                    <td class="value">{{ header_data.BillDate.strftime('%d/%b/%Y') if header_data.BillDate }}</td>
                </tr>
                <tr>
                    <td class="label">Dr. Name:</td>
                    <td class="value">{{ header_data.DrName }}</td>
                    <td class="label">Case:</td>
                    <td class="value">{{ header_data.Case }}</td>
                </tr>
                <tr>
                    <td class="label">Patient ID:</td>
                    <td class="value">{{ header_data.PatientID }}</td>
                    <td class="label">Patient Name:</td>
                    <td class="value">{{ header_data.PatientName }}</td>
                </tr>
            </table>

            <table class="items-table">
                <thead>
                    <tr>
                        {% if show_seq_id %}<th style="width:4%;">Id</th>{% endif %}
                        {% if show_sno %}<th style="width:5%;">SNo</th>{% endif %}
                        <th>Product Name</th>
                        <th>Batch No</th>
                        <th>Exp. Date</th>
                        <th class="right">Qty</th>
                        <th class="right">MRP</th>
                        <th class="right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr>
                        {% if show_seq_id %}<td>{{ loop.index }}</td>{% endif %}
                        {% if show_sno %}<td>{{ row.SNo }}</td>{% endif %}
                        <td>{{ row.ProductName }}</td>
                        <td>{{ row.BatchNo }}</td>
                        <td>{{ row.ExpDate.strftime('%d/%b/%Y') if row.ExpDate }}</td>
                        <td class="right">{{ row.Qty }}</td>
                        <td class="right">{{ "%.2f"|format(row.MRP) }}</td>
                        <td class="right">{{ "%.2f"|format(row.Total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    {% set colspan = 5 %}
                    {% if show_seq_id %}{% set colspan = colspan + 1 %}{% endif %}
                    {% if show_sno %}{% set colspan = colspan + 1 %}{% endif %}
                    <tr>
                        <td colspan="{{ colspan }}" class="right"><strong>Total Rs.</strong></td>
                        <td class="right"><strong>{{ "%.2f"|format(grand_total) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
            <p style="text-align: center; font-size: 12px; margin-top: 40px;">Please bring this bill for returning products.</p>
        </div>
    </div>
    {% endif %}

    <script>
        const printButton = document.getElementById('print_button');
        if (printButton) {
            printButton.addEventListener('click', function() {
                window.print();
            });
        }
    </script>

</body>
</html>
